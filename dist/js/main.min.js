var module=angular.module("multistreamApp",[]);module.controller("multistreamController",function($scope,$sce){function setMainChat(){""!=$scope.availableChats&&($scope.availableChats=$scope.streamList[0].channel,$scope.getMainChat())}function setChat(){currentLayout==column?(1==allChatVisibility?($scope.allChatIcon=downIcon,root.setProperty("-allChatButton-display","flex")):($scope.allChatIcon=upIcon,root.setProperty("-allChatButton-display","none")),toggleAllChat()):1==mainChatVisibility?($scope.mainChatIcon=rightIcon,root.setProperty("--mainChatButton-right","350px"),root.setProperty("--mainChat-display","flex")):($scope.mainChatIcon=leftIcon,root.setProperty("--mainChatButton-right","0"),root.setProperty("--mainChat-display","none"))}function toggleAllChat(){if(0==allChatVisibility)newDisplay="none";else var newDisplay="flex";root.setProperty("--chat-display",newDisplay)}function changeLayoutGrid(){root.setProperty("--chat-display","none"),root.setProperty("--mainChat-display","flex"),root.setProperty("--mainChatButton-display","block"),root.setProperty("--allChatButton-display","none"),root.setProperty("--stream-width","initial")}function changeLayoutColumn(){navigator.userAgent.indexOf("Firefox")>0&&(1==firstLoad||1==recentlyAdded)&&reloadAllChats(),root.setProperty("--chat-height","70%"),root.setProperty("--chat-width","100%"),root.setProperty("--chat-display","flex"),root.setProperty("--mainChat-display","none"),root.setProperty("--mainChatButton-display","none"),root.setProperty("--allChatButton-display","block"),root.setProperty("--stream-width","initial")}function reloadAllChats(){for(channel in $scope.streamList){streamID=$scope.streamList[channel].channel+"chat";var iframe=document.getElementById(streamID);null!=iframe&&(iframe.src=iframe.src)}firstLoad=!1}function updateLayout(){if(0!=$scope.streamList.length){root.setProperty("--bg","black");var numOfStreams=$scope.streamList.length,streamElementList=document.getElementsByClassName("stream"),focusStream=streamElementList[0];currentLayout==grid?updateLayoutGrid(focusStream,numOfStreams,streamElementList):updateLayoutColumn(focusStream,numOfStreams,streamElementList)}else root.setProperty("--bg","#5C6391"),root.setProperty("--mainChat-display","none"),root.setProperty("--mainChatButton-display","none"),root.setProperty("--allChatButton-display","none")}function updateLayoutGrid(focusStream,numOfStreams,streamElementList){1==numOfStreams&&root.setProperty("--mainChatButton-display","block"),2==numOfStreams?(root.setProperty("--stream-width","100%"),focusStream.style.width="var(--stream-width)"):3==numOfStreams?(root.setProperty("--stream-width","initial"),setStyle(streamElementList,"width","var(--stream-width)"),focusStream.style.width="100%"):4==numOfStreams?(root.setProperty("--stream-width","50%"),setStyle(streamElementList,"width","var(--stream-width)")):5==numOfStreams?(root.setProperty("--stream-width","50%"),setStyle(streamElementList,"width","var(--stream-width)"),focusStream.style.width="100%"):6==numOfStreams&&(root.setProperty("--stream-width","50%"),focusStream.style.width="var(--stream-width)")}function updateLayoutColumn(focusStream,numOfStreams,streamElementList){focusStream.style.width="var(--stream-width)",root.setProperty("--stream-width","initial")}function setStyle(elementList,style,newSetting){for(var i=0;i<=elementList.length-1;i++)elementList[i].style[style]=newSetting}function insertParam(){var channels;for(channel in $scope.streamList)channels+=String($scope.streamList[channel].channel)+",";channels=channels.replace("undefined","");var newurl=window.location.protocol+"//"+window.location.host+window.location.pathname+"?stream="+channels;window.history.pushState({path:newurl},"",newurl)}function deleteParam(removedChannel){var channels;for(channel in $scope.streamList)channels+=String($scope.streamList[channel].channel)+",";channels=(channels=channels.replace("undefined","")).replace(removedChannel+",","");var newurl=window.location.protocol+"//"+window.location.host+window.location.pathname+"?stream="+channels;window.history.pushState({path:newurl},"",newurl)}var root=document.documentElement.style,grid="grid",column="column",currentLayout=grid,firstLoad=!0,recentlyAdded=!0,navVisible=!0,playerUrl="http://player.twitch.tv/?channel=",chatStartUrl="http://www.twitch.tv/",upIcon="img/up.svg",downIcon="img/down.svg",leftIcon="img/left.svg",rightIcon="img/right.svg",mainChatVisibility=!0,allChatVisibility=!0;$scope.streamList=[],$scope.navIcon=upIcon,$scope.mainChatIcon=rightIcon,$scope.allChatIcon=downIcon,$scope.trustSrc=function(src){return $sce.trustAsResourceUrl(src)},$scope.addStream=function(){if(null!=$scope.input&&$scope.streamList.length<6){var channel=$scope.input,streamItem={channel:channel,player:playerUrl+channel,chat:chatStartUrl+channel+"/chat"};$scope.streamList.push(streamItem),$scope.input="",insertParam(),updateLayout();var numOfStreams=$scope.streamList.length;1==numOfStreams&&(setMainChat(),$scope.changeLayout(currentLayout)),0==numOfStreams&&$scope.changeLayout(currentLayout),recentlyAdded=!0}},$scope.deleteStream=function(){var removedStream=$scope.streamList[this.$index].channel;deleteParam(removedStream),$scope.streamList.splice(this.$index,1);var removedChatUrl=chatStartUrl+removedStream+"/chat",numOfStreams=$scope.streamList.length;removedChatUrl==$scope.mainChatUrl&&numOfStreams>0||1==numOfStreams?setMainChat():$scope.getMainChat(),currentLayout==grid&&updateLayout()},$scope.refreshStream=function(event){streamID=event.target.className+"player";var streamFrame=document.getElementById(streamID);streamFrame.src=streamFrame.src,chatID=event.target.className+"chat";var chatFrame=document.getElementById(chatID);chatFrame.src=chatFrame.src},$scope.refreshMainChat=function(){var iframe=document.getElementById("mainChat");iframe.src=iframe.src},$scope.getMainChat=function(){if(""!=$scope.availableChats){var chatUrlFormat=chatStartUrl+$scope.availableChats+"/chat";$scope.mainChatUrl=chatUrlFormat}},$scope.toggleChat=function(){currentLayout==column?allChatVisibility=!allChatVisibility:mainChatVisibility=!mainChatVisibility,setChat()},$scope.changeLayout=function(newLayout){(currentLayout=newLayout)==grid?changeLayoutGrid():currentLayout==column&&changeLayoutColumn(),setChat(),updateLayout()},$scope.toggleNav=function(){1==(navVisible=!navVisible)?(root.setProperty("--navBar-display","flex"),$scope.navIcon=upIcon,root.setProperty("--navToggle-top","2.9em"),root.setProperty("--mainChatButton-top","2.9em")):(root.setProperty("--navBar-display","none"),$scope.navIcon=downIcon,root.setProperty("--navToggle-top",0),root.setProperty("--mainChatButton-top",0))},$scope.clearStreams=function(){$scope.streamList.length=0},$scope.getParam=function(){window.location.href.slice(window.location.href.indexOf("?")+1).split("&");var urlParams=new URLSearchParams(location.search.substring(1));if(urlStreams=urlParams.get("stream"),""!==urlStreams&&null!==urlStreams){urlStreams=urlStreams.split(",");for(channel in urlStreams)if($scope.streamList.length<6){var channel=urlStreams[channel];if(""!==channel){var streamItem={channel:channel,player:playerUrl+channel,chat:chatStartUrl+channel+"/chat"};$scope.streamList.push(streamItem),toggleAllChat(),setMainChat()}}}setTimeout(function(){$scope.changeLayout(grid)},20)}});